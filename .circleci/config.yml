version: 2
jobs:
  build:
    environment:
      PRODUCER_NAME: dalecosta/service-producer-ts
      CONSUMER_NAME: dalecosta/service-consumer-ts
    docker:
      - image: circleci/buildpack-deps:stretch
        auth:
           username: $DOCKERHUB_USERNAME
           password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build Docker image producer
          working_directory: ~/service-producer-ts
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            docker push $PRODUCER_NAME:latest
      - run:
          name: Build Docker image consumer
          working_directory: ~/service-consumer-ts
          command: |
            echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            docker push $CONSUMER_NAME:latest
        
        
workflows:
  version: 2
  build-master:
    jobs:
      - build:
          filters:
            branches:
              only: main